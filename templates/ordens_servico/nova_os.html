{% extends "base.html" %}
{% block title %}Nova Ordem de Serviço{% endblock %}
{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3>Abrir Nova Ordem de Serviço</h3>
          <form method="POST">
            <input type="hidden" id="formulario_respostas" name="formulario_respostas">
            <div class="mb-3">
              <label for="titulo" class="form-label">Título <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="titulo" name="titulo" required>
            </div>
            <div class="mb-3">
              <label for="prioridade" class="form-label">Prioridade</label>
              <select class="form-select" id="prioridade" name="prioridade">
                <option value="">--</option>
                {% for p in prioridades %}
                <option value="{{ p.value }}">{{ p.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label d-block">Relacionado a</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="alvo_tipo" id="alvo_sistema" value="sistema">
                <label class="form-check-label" for="alvo_sistema">Sistema</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="alvo_tipo" id="alvo_equipamento" value="equipamento">
                <label class="form-check-label" for="alvo_equipamento">Equipamento</label>
              </div>
            </div>
            <div class="mb-3 d-none" id="equipamento_field">
              <label for="equipamento_id" class="form-label">Equipamento</label>
              <select class="form-select" id="equipamento_id" name="equipamento_id">
                <option value="">--</option>
                {% for e in equipamentos %}
                <option value="{{ e.id }}">{{ e.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3 d-none" id="sistema_field">
              <label for="sistema_id" class="form-label">Sistema</label>
              <select class="form-select" id="sistema_id" name="sistema_id">
                <option value="">--</option>
                {% for s in sistemas %}
                <option value="{{ s.id }}">{{ s.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="tipo_os_id" class="form-label">Categoria</label>
              <select class="form-select" id="tipo_os_id" name="tipo_os_id">
                <option value="">--</option>
                {% for t in tipos_os %}
                <option value="{{ t.id }}">{{ t.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3" id="formulario-vinculado"></div>
            <div class="d-flex gap-2">
              <button type="submit" name="action" value="rascunho" class="btn btn-secondary">Salvar Rascunho</button>
              <button type="submit" name="action" value="enviar" class="btn btn-primary">Enviar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  let inputs = form.querySelectorAll('input, textarea, select');
  const STORAGE_KEY = 'draft_nova_os';
  const equipamento = document.getElementById('equipamento_id');
  const sistema = document.getElementById('sistema_id');
  const equipamentoField = document.getElementById('equipamento_field');
  const sistemaField = document.getElementById('sistema_field');
  const alvoRadios = document.querySelectorAll('input[name="alvo_tipo"]');

  function save() {
    const data = {};
    inputs.forEach(i => {
      if (i.type === 'radio') {
        if (i.checked) data[i.name] = i.value;
      } else if (i.type === 'checkbox') {
        data[i.id] = i.checked;
      } else {
        data[i.id] = i.value;
      }
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      inputs.forEach(i => {
        if (i.type === 'radio') {
          if (data[i.name] === i.value) i.checked = true;
        } else if (i.type === 'checkbox') {
          if (data[i.id]) i.checked = true;
        } else {
          if (data[i.id]) i.value = data[i.id];
        }
      });
    } catch (e) {
      console.warn('Falha ao carregar rascunho da OS', e);
    }
  }

  function attachSaveListeners() {
    inputs.forEach(i => {
      i.addEventListener('input', save);
      i.addEventListener('change', save);
    });
  }

  load();
  attachSaveListeners();

  const tipoSelect = document.getElementById('tipo_os_id');
  const formContainer = document.getElementById('formulario-vinculado');
  let formularioObrigatorio = false;

  function getAlvoValue() {
    const checked = document.querySelector('input[name="alvo_tipo"]:checked');
    return checked ? checked.value : '';
  }

  function atualizarCampos() {
    const alvo = getAlvoValue();
    if (alvo === 'sistema') {
      sistemaField.classList.remove('d-none');
      equipamentoField.classList.add('d-none');
      sistema.setAttribute('required', 'required');
      equipamento.removeAttribute('required');
      sistemaField.querySelector('label').innerHTML = 'Sistema <span class="text-danger">*</span>';
      equipamentoField.querySelector('label').innerHTML = 'Equipamento';
    } else if (alvo === 'equipamento') {
      equipamentoField.classList.remove('d-none');
      sistemaField.classList.add('d-none');
      equipamento.setAttribute('required', 'required');
      sistema.removeAttribute('required');
      equipamentoField.querySelector('label').innerHTML = 'Equipamento <span class="text-danger">*</span>';
      sistemaField.querySelector('label').innerHTML = 'Sistema';
    } else {
      equipamentoField.classList.add('d-none');
      sistemaField.classList.add('d-none');
      equipamento.removeAttribute('required');
      sistema.removeAttribute('required');
      equipamentoField.querySelector('label').innerHTML = 'Equipamento';
      sistemaField.querySelector('label').innerHTML = 'Sistema';
    }
  }

  alvoRadios.forEach(r => r.addEventListener('change', atualizarCampos));

  function initFormularioVinculado() {
    const container = document.getElementById('formulario-vinculado');
    if (!container || !container.querySelector('.section-block')) return;

    container.querySelectorAll('.expand-video').forEach(btn => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.video;
        const iframe = container.querySelector('#videoExpandModal iframe');
        if (iframe) {
          iframe.src = url;
          const modal = new bootstrap.Modal(container.querySelector('#videoExpandModal'));
          modal.show();
        }
      });
    });
    const videoModal = container.querySelector('#videoExpandModal');
    if (videoModal) {
      videoModal.addEventListener('hidden.bs.modal', () => {
        const iframe = videoModal.querySelector('iframe');
        if (iframe) iframe.src = '';
      });
    }

    const sections = Array.from(container.querySelectorAll('.section-block'));
    const questions = Array.from(container.querySelectorAll('.question-block'));
    const questionById = new Map(questions.map(q => [q.dataset.id, q]));
    const questionToSection = new Map();
    sections.forEach((sec, sIdx) => {
      sec.querySelectorAll('.question-block').forEach(q => questionToSection.set(q, sIdx));
    });
    let history = [0];

    const branchDestinations = new Set();
    questions.forEach(q => {
      const ram = JSON.parse(q.dataset.ramificacoes || '[]');
      ram.forEach(r => {
        if (r.destino && r.destino !== 'next' && r.destino !== 'end') {
          branchDestinations.add(r.destino);
        }
      });
    });
    branchDestinations.forEach(id => {
      const el = questionById.get(id);
      if (el) hideQuestionAndDescendants(el);
    });

    function hideQuestionAndDescendants(qEl) {
      qEl.style.display = 'none';
      qEl.querySelectorAll('[required]').forEach(inp => {
        inp.dataset.wasRequired = 'true';
        inp.required = false;
      });
      const ram = JSON.parse(qEl.dataset.ramificacoes || '[]');
      ram.forEach(r => {
        if (r.destino && r.destino !== 'next' && r.destino !== 'end') {
          const destEl = questionById.get(r.destino);
          if (destEl) hideQuestionAndDescendants(destEl);
        }
      });
    }

    function showQuestion(qEl) {
      qEl.style.display = '';
      qEl.querySelectorAll('[data-was-required]').forEach(inp => {
        inp.required = true;
        inp.removeAttribute('data-was-required');
      });
    }

    function updateSectionsVisibility() {
      sections.forEach(sec => {
        const visible = Array.from(sec.querySelectorAll('.question-block')).some(q => q.style.display !== 'none');
        sec.style.display = visible ? '' : 'none';
      });
    }

    function findSectionByQuestionId(id) {
      return sections.findIndex(sec => Array.from(sec.querySelectorAll('.question-block')).some(q => q.dataset.id === id));
    }

    function determineNext(idx) {
      const qs = Array.from(sections[idx].querySelectorAll('.question-block')).filter(q => q.style.display !== 'none');
      for (const q of qs) {
        const ram = JSON.parse(q.dataset.ramificacoes || '[]');
        if (!ram.length) continue;
        let val = null;
        const sel = q.querySelector('select');
        if (sel) val = sel.value; else {
          const checked = q.querySelector('input[type=radio]:checked');
          if (checked) val = checked.value;
        }
        if (val) {
          const rule = ram.find(r => r.opcao === val);
          if (rule) {
            if (rule.destino === 'end') return -1;
            if (rule.destino !== 'next') {
              const destIdx = findSectionByQuestionId(rule.destino);
              if (destIdx !== -1 && destIdx !== idx) return destIdx;
            }
          }
        }
      }
      let nextIdx = idx + 1;
      while (nextIdx < sections.length) {
        const hasVisible = Array.from(sections[nextIdx].querySelectorAll('.question-block')).some(q => q.style.display !== 'none');
        if (hasVisible) break;
        nextIdx++;
      }
      return nextIdx < sections.length ? nextIdx : -1;
    }

    function showSection(idx) {
      sections.forEach((sec, i) => { sec.style.display = i === idx ? '' : 'none'; });
      const titleEl = sections[idx].querySelector('h4');
      const subtitleEl = sections[idx].querySelector('p.text-muted');
      let title = titleEl?.textContent.trim();
      let subtitle = subtitleEl?.textContent.trim();
      let display = title || `Seção ${idx + 1}`;
      if (subtitle) display += ` - ${subtitle}`;
      container.querySelector('#sectionTitle').textContent = display;
      const pct = ((idx + 1) / sections.length) * 100;
      container.querySelector('#progressBar').style.width = pct + '%';
      const backBtn = container.querySelector('#backBtn');
      const nextBtn = container.querySelector('#nextBtn');
      backBtn.style.display = history.length > 1 ? '' : 'none';
      if (determineNext(idx) === -1) {
        nextBtn.classList.add('d-none');
      } else {
        nextBtn.classList.remove('d-none');
      }
    }

    function handleBranchChange(q, idx) {
      const ram = JSON.parse(q.dataset.ramificacoes || '[]');
      let val = null;
      const sel = q.querySelector('select');
      if (sel) val = sel.value; else {
        const checked = q.querySelector('input[type=radio]:checked');
        if (checked) val = checked.value;
      }

      if (q.dataset.activeDest && q.dataset.activeDest !== 'next' && q.dataset.activeDest !== 'end') {
        const prevEl = questionById.get(q.dataset.activeDest);
        if (prevEl) hideQuestionAndDescendants(prevEl);
      }

      const currentSecIdx = questionToSection.get(q);
      const pos = history.indexOf(currentSecIdx);
      history = pos === -1 ? [currentSecIdx] : history.slice(0, pos + 1);

      let rule = null;
      if (val) {
        rule = ram.find(r => r.opcao === val);
      }
      q.dataset.activeDest = rule ? rule.destino : '';

      if (rule) {
        if (rule.destino === 'end') {
          for (let i = idx + 1; i < questions.length; i++) {
            hideQuestionAndDescendants(questions[i]);
          }
          updateSectionsVisibility();
          showSection(currentSecIdx);
          return;
        }
        if (rule.destino && rule.destino !== 'next') {
          const destEl = questionById.get(rule.destino);
          if (destEl) {
            showQuestion(destEl);
            const destSecIdx = questionToSection.get(destEl);
            sections[destSecIdx].style.display = '';
            updateSectionsVisibility();
            if (destSecIdx !== currentSecIdx) {
              history.push(destSecIdx);
              showSection(destSecIdx);
              return;
            }
            const destIdx = questions.indexOf(destEl);
            const nextAfterDest = questions[destIdx + 1];
            if (nextAfterDest) showQuestion(nextAfterDest);
          }
        }
      }
      updateSectionsVisibility();
      showSection(currentSecIdx);
    }

    questions.forEach((q, idx) => {
      const ram = JSON.parse(q.dataset.ramificacoes || '[]');
      if (!ram.length) return;
      const inputs = q.querySelectorAll('select, input[type=radio]');
      inputs.forEach(inp => {
        inp.addEventListener('change', () => handleBranchChange(q, idx));
      });
    });

    const nextBtn = container.querySelector('#nextBtn');
    const backBtn = container.querySelector('#backBtn');

    nextBtn.addEventListener('click', () => {
      const currentSection = sections[history[history.length - 1]];
      const inputs = currentSection.querySelectorAll('input, select, textarea');
      for (const inp of inputs) {
        if (!inp.checkValidity()) {
          inp.reportValidity();
          return;
        }
      }
      const target = determineNext(history[history.length - 1]);
      if (target === -1) {
        return;
      }
      history.push(target);
      showSection(target);
    });

    backBtn.addEventListener('click', () => {
      if (history.length > 1) {
        history.pop();
        showSection(history[history.length - 1]);
      }
    });

    updateSectionsVisibility();
    sections.forEach((sec, i) => { if (i !== 0) sec.style.display = 'none'; });
    backBtn.style.display = 'none';
    showSection(0);
  }

  tipoSelect.addEventListener('change', () => {
    const tipoId = tipoSelect.value;
    if (!tipoId) {
      formContainer.innerHTML = '';
      formularioObrigatorio = false;
      inputs = form.querySelectorAll('input, textarea, select');
      attachSaveListeners();
      return;
    }
    fetch(`/os/tipo/${tipoId}/formulario`)
      .then(r => r.json())
      .then(data => {
        formContainer.innerHTML = data.html || '';
        formularioObrigatorio = data.obrigatorio;
        inputs = form.querySelectorAll('input, textarea, select');
        attachSaveListeners();
        initFormularioVinculado();
      })
      .catch(() => {
        formContainer.innerHTML = '';
        formularioObrigatorio = false;
      });
  });

  atualizarCampos();
  initFormularioVinculado();

  function coletarRespostas() {
    const respostas = {};
    const container = document.getElementById('formulario-vinculado');
    if (!container) return respostas;
    container.querySelectorAll('.question-block').forEach(q => {
      const id = q.dataset.id;
      if (!id) return;
      let valor = null;
      const inputs = q.querySelectorAll('input, textarea, select');
      if (inputs.length === 1) {
        const inp = inputs[0];
        if (inp.type === 'checkbox') {
          const checked = q.querySelectorAll('input[type="checkbox"]:checked');
          if (checked.length) valor = Array.from(checked).map(c => c.value);
        } else if (inp.type === 'radio') {
          const checked = q.querySelector('input[type="radio"]:checked');
          if (checked) valor = checked.value;
        } else if (inp.tagName === 'SELECT' && inp.multiple) {
          valor = Array.from(inp.selectedOptions).map(o => o.value);
        } else {
          valor = inp.value;
        }
      } else if (inputs.length > 1) {
        const checkedRadios = q.querySelector('input[type="radio"]:checked');
        if (checkedRadios) {
          valor = checkedRadios.value;
        } else {
          const checkedBoxes = q.querySelectorAll('input[type="checkbox"]:checked');
          if (checkedBoxes.length) valor = Array.from(checkedBoxes).map(c => c.value);
        }
      }
      if (valor !== null && valor !== '' && !(Array.isArray(valor) && valor.length === 0)) {
        respostas[id] = valor;
      }
    });
    return respostas;
  }

  form.addEventListener('submit', (e) => {
    const alvo = getAlvoValue();
    if (alvo === 'sistema' && !sistema.value) {
      e.preventDefault();
      alert('O campo Sistema é obrigatório.');
      return;
    }
    if (alvo === 'equipamento' && !equipamento.value) {
      e.preventDefault();
      alert('O campo Equipamento é obrigatório.');
      return;
    }
    if (formularioObrigatorio) {
      const campos = formContainer.querySelectorAll('input, textarea, select');
      const algumPreenchido = Array.from(campos).some(c => {
        if (c.type === 'checkbox' || c.type === 'radio') return c.checked;
        return c.value && c.value.trim() !== '';
      });
      if (!algumPreenchido) {
        e.preventDefault();
        alert('Preenchimento do formulário vinculado é obrigatório.');
        return;
      }
    }
    const respostas = coletarRespostas();
    document.getElementById('formulario_respostas').value = JSON.stringify(respostas);
    localStorage.removeItem(STORAGE_KEY);
  });

});
</script>
{% endblock %}
