{% extends "base.html" %}
{% block title %}Nova Ordem de Serviço{% endblock %}
{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3>Abrir Nova Ordem de Serviço</h3>
          <form method="POST">
            <div class="mb-3">
              <label for="titulo" class="form-label">Título <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="titulo" name="titulo" required>
            </div>
            <div class="mb-3">
              <label for="prioridade" class="form-label">Prioridade</label>
              <select class="form-select" id="prioridade" name="prioridade">
                <option value="">--</option>
                {% for p in prioridades %}
                <option value="{{ p.value }}">{{ p.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="alvo_tipo" class="form-label">Relacionado a</label>
              <select class="form-select" id="alvo_tipo" name="alvo_tipo">
                <option value="">--</option>
                <option value="sistema">Sistema</option>
                <option value="equipamento">Equipamento</option>
              </select>
            </div>
            <div class="mb-3 d-none" id="equipamento_field">
              <label for="equipamento_id" class="form-label">Equipamento</label>
              <select class="form-select" id="equipamento_id" name="equipamento_id">
                <option value="">--</option>
                {% for e in equipamentos %}
                <option value="{{ e.id }}">{{ e.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3 d-none" id="sistema_field">
              <label for="sistema_id" class="form-label">Sistema</label>
              <select class="form-select" id="sistema_id" name="sistema_id">
                <option value="">--</option>
                {% for s in sistemas %}
                <option value="{{ s.id }}">{{ s.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="tipo_os_id" class="form-label">Categoria</label>
              <select class="form-select" id="tipo_os_id" name="tipo_os_id">
                <option value="">--</option>
                {% for t in tipos_os %}
                <option value="{{ t.id }}">{{ t.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3" id="formulario-vinculado"></div>
            <div class="d-flex gap-2">
              <button type="submit" name="action" value="rascunho" class="btn btn-secondary">Salvar Rascunho</button>
              <button type="submit" name="action" value="enviar" class="btn btn-primary">Enviar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  let inputs = form.querySelectorAll('input, textarea, select');
  const STORAGE_KEY = 'draft_nova_os';
  const equipamento = document.getElementById('equipamento_id');
  const sistema = document.getElementById('sistema_id');
  const equipamentoField = document.getElementById('equipamento_field');
  const sistemaField = document.getElementById('sistema_field');
  const alvoSelect = document.getElementById('alvo_tipo');
  function save() {
    const data = {};
    inputs.forEach(i => data[i.id] = i.value);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      inputs.forEach(i => { if (data[i.id]) i.value = data[i.id]; });
    } catch (e) {
      console.warn('Falha ao carregar rascunho da OS', e);
    }
  }
  load();
  inputs.forEach(i => i.addEventListener('input', save));
  const tipoSelect = document.getElementById('tipo_os_id');
  const formContainer = document.getElementById('formulario-vinculado');
  let formularioObrigatorio = false;
  function atualizarCampos() {
    const alvo = alvoSelect.value;
    if (alvo === 'sistema') {
      sistemaField.classList.remove('d-none');
      equipamentoField.classList.add('d-none');
      sistema.setAttribute('required', 'required');
      equipamento.removeAttribute('required');
      sistemaField.querySelector('label').innerHTML = 'Sistema <span class="text-danger">*</span>';
      equipamentoField.querySelector('label').innerHTML = 'Equipamento';
    } else if (alvo === 'equipamento') {
      equipamentoField.classList.remove('d-none');
      sistemaField.classList.add('d-none');
      equipamento.setAttribute('required', 'required');
      sistema.removeAttribute('required');
      equipamentoField.querySelector('label').innerHTML = 'Equipamento <span class="text-danger">*</span>';
      sistemaField.querySelector('label').innerHTML = 'Sistema';
    } else {
      equipamentoField.classList.add('d-none');
      sistemaField.classList.add('d-none');
      equipamento.removeAttribute('required');
      sistema.removeAttribute('required');
      equipamentoField.querySelector('label').innerHTML = 'Equipamento';
      sistemaField.querySelector('label').innerHTML = 'Sistema';
    }
  }

  alvoSelect.addEventListener('change', () => {
    atualizarCampos();
  });

  tipoSelect.addEventListener('change', () => {
    const tipoId = tipoSelect.value;
    if (!tipoId) {
      formContainer.innerHTML = '';
      formularioObrigatorio = false;
      inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(i => i.addEventListener('input', save));
      return;
    }
    fetch(`/os/tipo/${tipoId}/formulario`)
      .then(r => r.json())
      .then(data => {
        formContainer.innerHTML = data.html || '';
        formularioObrigatorio = data.obrigatorio;
        inputs = form.querySelectorAll('input, textarea, select');
        inputs.forEach(i => i.addEventListener('input', save));
      })
      .catch(() => {
        formContainer.innerHTML = '';
        formularioObrigatorio = false;
      });
  });
  atualizarCampos();

  form.addEventListener('submit', (e) => {
    const alvo = alvoSelect.value;
    if (alvo === 'sistema' && !sistema.value) {
      e.preventDefault();
      alert('O campo Sistema é obrigatório.');
      return;
    }
    if (alvo === 'equipamento' && !equipamento.value) {
      e.preventDefault();
      alert('O campo Equipamento é obrigatório.');
      return;
    }
    if (formularioObrigatorio) {
      const campos = formContainer.querySelectorAll('input, textarea, select');
      const algumPreenchido = Array.from(campos).some(c => {
        if (c.type === 'checkbox' || c.type === 'radio') return c.checked;
        return c.value && c.value.trim() !== '';
      });
      if (!algumPreenchido) {
        e.preventDefault();
        alert('Preenchimento do formulário vinculado é obrigatório.');
        return;
      }
    }
    localStorage.removeItem(STORAGE_KEY);
  });

});
</script>
{% endblock %}
