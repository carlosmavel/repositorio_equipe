{% extends "base.html" %}
{% block title %}Detalhes da OS{% endblock %}
{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h3>{{ ordem.titulo }}</h3>
      <p class="text-muted mb-1">Categoria: {{ ordem.tipo_os.nome if ordem.tipo_os else '' }}</p>
      <p class="text-muted mb-1">Prioridade: {{ ordem.prioridade or 'N/A' }}</p>
      <p class="text-muted">Status atual: {{ status_choices(ordem.status).label }}</p>
    </div>
  </div>
  {% if formulario_estrutura %}
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      {% set estrutura = formulario_estrutura %}
      {% include 'ordens_servico/_formulario_vinculado_readonly.html' %}
    </div>
  </div>
  {% endif %}
  <div class="mb-3">
    <form method="post" action="{{ url_for('ordens_servico_bp.os_mudar_status', ordem_id=ordem.codigo) }}" class="d-flex">
      <select class="form-select form-select-sm" name="status">
        {% for st in status_choices %}
          <option value="{{ st.value }}" {% if ordem.status==st.value %}selected{% endif %}>{{ st.label }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-sm btn-primary ms-2">Alterar</button>
    </form>
  </div>
  <div class="card shadow-sm mb-3">
    <div class="card-header">Comentários</div>
    <div class="card-body">
      {% for c in comentarios %}
        <div class="mb-2">
          <strong>{{ c.usuario.nome_completo or c.usuario.username }}</strong>
          <small class="text-muted">{{ c.data_hora.strftime('%d/%m/%Y %H:%M') }}</small>
          {% if c.mensagem %}<p class="mb-0">{{ c.mensagem }}</p>{% endif %}
          {% if c.anexo %}<a href="{{ url_for('static', filename='uploads/' ~ c.anexo) }}">{{ c.anexo }}</a>{% endif %}
        </div>
      {% else %}
        <p class="text-muted">Nenhum comentário.</p>
      {% endfor %}
      <form method="post" action="{{ url_for('ordens_servico_bp.os_comentar', ordem_id=ordem.codigo) }}" class="mt-3">
        <div class="input-group">
          <input type="text" class="form-control form-control-sm" name="mensagem" placeholder="Adicionar comentário">
          <button class="btn btn-sm btn-primary">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
