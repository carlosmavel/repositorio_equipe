{% extends "base.html" %}
{% block title %}Preencher Formulário{% endblock %}
{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <h3 class="mb-3">Preencher Formulário: {{ formulario.nome }}</h3>
      {% if can_edit %}
        <a href="{{ url_for('formularios_bp.editar_formulario', id=formulario.id) }}" class="btn btn-secondary mb-3">Editar</a>
      {% endif %}
      <div class="form-container">
        <form>
        {% macro render_campo(campo, idx) %}
        <div class="mb-3 question-block" data-id="{{ campo.id }}" data-ramificacoes='{{ (campo.ramificacoes or [])|tojson }}'>
          <div class="d-flex justify-content-between">
            <div class="flex-grow-1 me-3">
              <label class="form-label">{{ campo.label }}{% if campo.obrigatoria %} *{% endif %}</label>
              {% if campo.subtitulo %}<div class="form-text mb-2">{{ campo.subtitulo }}</div>{% endif %}
            </div>
            <div class="text-end">
              {% if campo.midia_url %}
                <img src="{{ campo.midia_url }}" class="img-fluid mb-2" style="max-width: 200px;" alt="">
              {% endif %}
              {% if campo.video_url %}
                <div class="video-holder">
                  <iframe width="250" height="140" src="{{ campo.video_url }}" allowfullscreen></iframe>
                  <button type="button" class="btn btn-link p-0 mt-1 expand-video" data-video="{{ campo.video_url }}">Expandir</button>
                </div>
              {% endif %}
            </div>
          </div>
          {% if campo.tipo == 'textarea' %}
            <textarea class="form-control" {% if campo.obrigatoria %}required{% endif %}></textarea>
          {% elif campo.tipo == 'select' %}
            <select class="form-select" {% if campo.obrigatoria %}required{% endif %}>
              {% for opcao in campo.opcoes %}
                <option value="{{ opcao }}">{{ opcao }}</option>
              {% endfor %}
            </select>
          {% elif campo.tipo == 'option' %}
            {% if campo.usarMenuSuspenso %}
              <select class="form-select" {% if campo.permiteMultiplaEscolha %}multiple{% endif %} {% if campo.obrigatoria %}required{% endif %} {% if campo.temOpcaoOutra %}data-outra-select{% endif %}>
                {% for opcao in campo.opcoes %}
                  <option value="{{ opcao }}">{{ opcao }}</option>
                {% endfor %}
                {% if campo.temOpcaoOutra %}
                  <option value="outra">Outra</option>
                {% endif %}
              </select>
              {% if campo.temOpcaoOutra %}<input type="text" class="form-control mt-2 d-none outra-especifique" placeholder="Especifique">{% endif %}
            {% else %}
              {% set input_type = 'checkbox' if campo.permiteMultiplaEscolha else 'radio' %}
              {% for opcao in campo.opcoes %}
                <div class="form-check">
                  <input class="form-check-input" type="{{ input_type }}" name="campo{{ idx }}{% if campo.permiteMultiplaEscolha %}[]{% endif %}" value="{{ opcao }}" {% if campo.obrigatoria %}required{% endif %}>
                  <label class="form-check-label">{{ opcao }}</label>
                </div>
              {% endfor %}
              {% if campo.temOpcaoOutra %}
                <div class="form-check mt-2">
                  <input class="form-check-input outra-option" type="{{ input_type }}" name="campo{{ idx }}{% if campo.permiteMultiplaEscolha %}[]{% endif %}" value="outra">
                  <label class="form-check-label">Outra</label>
                </div>
                <input type="text" class="form-control mt-2 d-none outra-especifique" placeholder="Especifique">
              {% endif %}
            {% endif %}
          {% elif campo.tipo == 'rating' %}
            {% set opcoes = campo.opcoes if campo.opcoes else ['1','2','3','4','5'] %}
            <select class="form-select" {% if campo.obrigatoria %}required{% endif %}>
              {% for opcao in opcoes %}
                <option value="{{ opcao }}">{{ opcao }}</option>
              {% endfor %}
            </select>
          {% elif campo.tipo == 'date' %}
            <input type="date" class="form-control date-field" placeholder="dd/mm/aaaa" {% if campo.obrigatoria %}required{% endif %}>
          {% elif campo.tipo == 'likert' %}
            {% set linhas = campo.linhas if campo.linhas else ['Item 1'] %}
            {% set colunas = campo.colunas if campo.colunas else ['Discordo totalmente','Discordo','Neutro','Concordo','Concordo totalmente'] %}
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th></th>
                    {% for col in colunas %}
                      <th class="text-center">{{ col }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for linha in linhas %}
                    {% set row_index = loop.index0 %}
                    <tr>
                      <th>{{ linha }}</th>
                      {% for col in colunas %}
                        <td class="text-center">
                          <input class="form-check-input" type="radio" name="campo{{ idx }}_{{ row_index }}" value="{{ col }}" {% if campo.obrigatoria %}required{% endif %}>
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% elif campo.tipo == 'file' %}
            <input type="file" class="form-control" {% if campo.obrigatoria %}required{% endif %}>
          {% elif campo.tipo == 'nps' %}
            <div class="d-flex flex-wrap">
              {% for i in range(11) %}
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="campo{{ idx }}" value="{{ i }}" {% if campo.obrigatoria %}required{% endif %}>
                  <label class="form-check-label">{{ i }}</label>
                </div>
              {% endfor %}
            </div>
          {% elif campo.tipo == 'table' %}
            <div class="table-responsive">
              <table class="table table-bordered">
                {% set cabecalhos = campo.opcoes if campo.opcoes else [] %}
                {% if cabecalhos %}
                  <thead>
                    <tr>
                      {% for cab in cabecalhos %}
                        <th>{{ cab }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                {% endif %}
                <tbody>
                  {% set total_linhas = campo.linhas if campo.linhas else 1 %}
                  {% for r in range(total_linhas) %}
                    <tr>
                      {% if cabecalhos %}
                        {% for cab in cabecalhos %}
                          <td><input type="text" class="form-control"></td>
                        {% endfor %}
                      {% else %}
                        <td>Sem colunas definidas</td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <input type="text" class="form-control" {% if campo.obrigatoria %}required{% endif %}>
          {% endif %}
        </div>
        {% endmacro %}
        <div class="mb-3">
          <h5 id="sectionTitle" class="mb-2"></h5>
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
          </div>
        </div>
        {% set q_idx = namespace(value=0) %}
        {% for bloco in estrutura %}
          {% if bloco.tipo == 'section' %}
            <div class="section-block mb-4" data-section-index="{{ loop.index0 }}">
              <div class="d-flex justify-content-between">
                <div class="flex-grow-1 me-3">
                  <h4 class="mb-1">{{ bloco.titulo }}</h4>
                  {% if bloco.subtitulo %}<p class="text-muted mb-2">{{ bloco.subtitulo }}</p>{% endif %}
                </div>
                <div class="text-end">
                  {% if bloco.imagem_url %}<img src="{{ bloco.imagem_url }}" class="img-fluid mb-2" style="max-width: 200px;" alt="">{% endif %}
                  {% if bloco.video_url %}<div class="video-holder"><iframe width="250" height="140" src="{{ bloco.video_url }}" allowfullscreen></iframe><button type="button" class="btn btn-link p-0 mt-1 expand-video" data-video="{{ bloco.video_url }}">Expandir</button></div>{% endif %}
                </div>
              </div>
              {% for campo in bloco.campos %}
                {{ render_campo(campo, q_idx.value) }}
                {% set q_idx.value = q_idx.value + 1 %}
              {% endfor %}
            </div>
          {% else %}
            <div class="section-block mb-4" data-section-index="{{ loop.index0 }}">
              {{ render_campo(bloco, q_idx.value) }}
              {% set q_idx.value = q_idx.value + 1 %}
            </div>
          {% endif %}
        {% endfor %}
        <div class="d-flex mt-3 align-items-center flex-wrap gap-2" id="navButtons">
          <button type="button" class="btn btn-secondary" id="backBtn">Voltar</button>
          <div class="ms-auto d-flex gap-2">
            <button type="button" class="btn btn-primary" id="nextBtn">Próximo</button>
            <button type="submit" class="btn btn-primary d-none" id="submitBtn">Enviar</button>
          </div>
        </div>
      </form>
      </div>
      <div class="modal fade" id="videoExpandModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-body p-0">
              <iframe width="100%" height="400" src="" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
{{ super() }}
<script>
document.querySelectorAll('.expand-video').forEach(btn => {
  btn.addEventListener('click', () => {
    const url = btn.dataset.video;
    const iframe = document.querySelector('#videoExpandModal iframe');
    iframe.src = url;
    const modal = new bootstrap.Modal(document.getElementById('videoExpandModal'));
    modal.show();
  });
});
document.getElementById('videoExpandModal').addEventListener('hidden.bs.modal', () => {
  document.querySelector('#videoExpandModal iframe').src = '';
});

// Ramificação no preenchimento
document.addEventListener('DOMContentLoaded', () => {
  const sections = Array.from(document.querySelectorAll('.section-block'));
  const questions = Array.from(document.querySelectorAll('.question-block'));
  const questionById = new Map(questions.map(q => [q.dataset.id, q]));
  const questionToSection = new Map();
  sections.forEach((sec, sIdx) => {
    sec.querySelectorAll('.question-block').forEach(q => questionToSection.set(q, sIdx));
  });
  let history = [0];

  // Oculta todas as perguntas que são destino de ramificações
  const branchDestinations = new Set();
  questions.forEach(q => {
    const ram = JSON.parse(q.dataset.ramificacoes || '[]');
    ram.forEach(r => {
      if (r.destino && r.destino !== 'next' && r.destino !== 'end') {
        branchDestinations.add(r.destino);
      }
    });
  });
  branchDestinations.forEach(id => {
    const el = questionById.get(id);
    if (el) el.style.display = 'none';
  });

  function hideQuestionAndDescendants(qEl) {
    qEl.style.display = 'none';
    const ram = JSON.parse(qEl.dataset.ramificacoes || '[]');
    ram.forEach(r => {
      if (r.destino && r.destino !== 'next' && r.destino !== 'end') {
        const destEl = questionById.get(r.destino);
        if (destEl) hideQuestionAndDescendants(destEl);
      }
    });
  }

  function updateSectionsVisibility() {
    sections.forEach(sec => {
      const visible = Array.from(sec.querySelectorAll('.question-block'))
        .some(q => q.style.display !== 'none');
      sec.style.display = visible ? '' : 'none';
    });
  }

  function findSectionByQuestionId(id) {
    return sections.findIndex(sec => Array.from(sec.querySelectorAll('.question-block'))
      .some(q => q.dataset.id === id));
  }

  function determineNext(idx) {
    const qs = Array.from(sections[idx].querySelectorAll('.question-block'))
      .filter(q => q.style.display !== 'none');
    for (const q of qs) {
      const ram = JSON.parse(q.dataset.ramificacoes || '[]');
      if (!ram.length) continue;
      let val = null;
      const sel = q.querySelector('select');
      if (sel) val = sel.value;
      else {
        const checked = q.querySelector('input[type=radio]:checked');
        if (checked) val = checked.value;
      }
      if (val) {
        const rule = ram.find(r => r.opcao === val);
        if (rule) {
          if (rule.destino === 'end') return -1;
          if (rule.destino !== 'next') {
            const destIdx = findSectionByQuestionId(rule.destino);
            if (destIdx !== -1) return destIdx;
          }
        }
      }
    }
    let nextIdx = idx + 1;
    while (nextIdx < sections.length) {
      const hasVisible = Array.from(sections[nextIdx].querySelectorAll('.question-block'))
        .some(q => q.style.display !== 'none');
      if (hasVisible) break;
      nextIdx++;
    }
    return nextIdx < sections.length ? nextIdx : -1;
  }

  function showSection(idx) {
    sections.forEach((sec, i) => { sec.style.display = i === idx ? '' : 'none'; });
    const title = sections[idx].querySelector('h4')?.textContent || `Seção ${idx + 1}`;
    document.getElementById('sectionTitle').textContent = title;
    const pct = ((idx + 1) / sections.length) * 100;
    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('backBtn').style.display = history.length > 1 ? '' : 'none';
    if (determineNext(idx) === -1) {
      document.getElementById('nextBtn').classList.add('d-none');
      document.getElementById('submitBtn').classList.remove('d-none');
    } else {
      document.getElementById('nextBtn').classList.remove('d-none');
      document.getElementById('submitBtn').classList.add('d-none');
    }
  }

  function handleBranchChange(q, idx) {
    const ram = JSON.parse(q.dataset.ramificacoes || '[]');
    let val = null;
    const sel = q.querySelector('select');
    if (sel) val = sel.value; else {
      const checked = q.querySelector('input[type=radio]:checked');
      if (checked) val = checked.value;
    }

    // oculta todos os destinos possíveis antes de aplicar nova regra
    ram.forEach(r => {
      if (r.destino && r.destino !== 'next' && r.destino !== 'end') {
        const destEl = questionById.get(r.destino);
        if (destEl) hideQuestionAndDescendants(destEl);
      }
    });

    const currentSecIdx = questionToSection.get(q);
    const pos = history.indexOf(currentSecIdx);
    history = pos === -1 ? [currentSecIdx] : history.slice(0, pos + 1);

    if (val) {
      const rule = ram.find(r => r.opcao === val);
      if (rule) {
        if (rule.destino === 'end') {
          for (let i = idx + 1; i < questions.length; i++) {
            hideQuestionAndDescendants(questions[i]);
          }
          updateSectionsVisibility();
          showSection(currentSecIdx);
          return;
        }
        if (rule.destino !== 'next') {
          const destEl = questionById.get(rule.destino);
          if (destEl) {
            destEl.style.display = '';
            const destSecIdx = questionToSection.get(destEl);
            sections[destSecIdx].style.display = '';
            updateSectionsVisibility();
            if (destSecIdx !== currentSecIdx) {
              history.push(destSecIdx);
              showSection(destSecIdx);
              return;
            }
          }
        }
      }
    }
    updateSectionsVisibility();
    showSection(currentSecIdx);
  }

  questions.forEach((q, idx) => {
    const ram = JSON.parse(q.dataset.ramificacoes || '[]');
    if (!ram.length) return;
    const inputs = q.querySelectorAll('select, input[type=radio]');
    inputs.forEach(inp => {
      inp.addEventListener('change', () => handleBranchChange(q, idx));
    });
  });

  const nextBtn = document.getElementById('nextBtn');
  const backBtn = document.getElementById('backBtn');
  const submitBtn = document.getElementById('submitBtn');

  nextBtn.addEventListener('click', () => {
    const target = determineNext(history[history.length - 1]);
    if (target === -1) {
      submitBtn.click();
      return;
    }
    history.push(target);
    showSection(target);
  });

  backBtn.addEventListener('click', () => {
    if (history.length > 1) {
      history.pop();
      showSection(history[history.length - 1]);
    }
  });

  updateSectionsVisibility();
  sections.forEach((sec, i) => { if (i !== 0) sec.style.display = 'none'; });
  backBtn.style.display = 'none';
  showSection(0);
});
</script>
{% endblock %}
