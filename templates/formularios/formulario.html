{% extends "base.html" %}
{% block title %}Formulários{% endblock %}
{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom">
    <h1 class="h2">Formulários</h1>
  </div>

  <ul class="nav nav-tabs" id="tabFormularios" role="tablist">
    <li class="nav-item">
      <button class="nav-link {% if aba_ativa != 'cadastro' %}active{% endif %}" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta" type="button" role="tab">Consulta</button>
    </li>
    <li class="nav-item">
      <button class="nav-link {% if aba_ativa == 'cadastro' %}active{% endif %}" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button" role="tab">Cadastro</button>
    </li>
  </ul>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="tab-content" id="tabFormulariosContent">
        <div class="tab-pane fade {% if aba_ativa != 'cadastro' %}show active{% endif %} p-3" id="consulta" role="tabpanel" aria-labelledby="consulta-tab">
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Formulários Cadastrados ({{ formularios|length }})</h5>
            </div>
            <div class="card-body">
              <div class="mb-3 row">
                <div class="col-md-6">
                  <form method="get" class="d-flex">
                    <select class="form-select me-2" name="status" onchange="this.form.submit()">
                      <option value="ativos" {% if status == 'ativos' %}selected{% endif %}>Ativos</option>
                      <option value="inativos" {% if status == 'inativos' %}selected{% endif %}>Inativos</option>
                      <option value="todos" {% if status == 'todos' %}selected{% endif %}>Todos</option>
                    </select>
                  </form>
                </div>
                <div class="col-md-6">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="formSearch" class="form-control" placeholder="Buscar por formulário">
                  </div>
                </div>
              </div>
              {% if formularios %}
              <table class="table table-striped" id="tabelaFormularios">
                <thead><tr><th>Nome</th><th>Status</th><th>Ações</th></tr></thead>
                <tbody>
                {% for f in formularios %}
                  <tr data-nome="{{ f.nome }}" class="{{ 'table-light text-muted' if not f.ativo else '' }}">
                    <td>{{ f.nome }}</td>
                    <td>{% if f.ativo %}<span class="badge bg-success">Ativo</span>{% else %}<span class="badge bg-secondary">Inativo</span>{% endif %}</td>
                    <td>
                      <a class="btn btn-sm btn-primary" href="{{ url_for('formularios_bp.preencher_formulario', id=f.id) }}">Preencher</a>
                      <a class="btn btn-sm btn-secondary ms-1" href="{{ url_for('formularios_bp.editar_formulario', id=f.id) }}">Editar</a>
                      <form action="{{ url_for('formularios_bp.toggle_ativo_formulario', id=f.id) }}" method="post" class="d-inline">
                        {% if f.ativo %}
                        <button type="submit" class="btn btn-sm btn-outline-warning ms-1">Desativar</button>
                        {% else %}
                        <button type="submit" class="btn btn-sm btn-outline-success ms-1">Ativar</button>
                        {% endif %}
                      </form>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
              {% else %}
              <p class="text-muted">Nenhum formulário cadastrado.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="tab-pane fade {% if aba_ativa == 'cadastro' %}show active{% endif %} p-3" id="cadastro" role="tabpanel" aria-labelledby="cadastro-tab">
          {% set action_url = url_for('formularios_bp.formularios') %}
          {% set formulario = None %}
          {% include 'formularios/cadastro_formulario.html' %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/form_builder.js') }}"></script>
<script>
const busca = document.getElementById('formSearch');
if (busca) {
  busca.addEventListener('keyup', function() {
    const termo = this.value.toLowerCase();
    document.querySelectorAll('#tabelaFormularios tbody tr').forEach(function(linha) {
      const nome = linha.dataset.nome.toLowerCase();
      linha.style.display = nome.includes(termo) ? '' : 'none';
    });
  });
}
</script>
{% endblock %}
