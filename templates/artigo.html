{# templates/artigo.html #}
{% extends 'base.html' %}
{% block title %}{{ artigo.titulo }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-8 mx-auto">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3>{{ artigo.titulo }}</h3>
        <p class="text-muted">
          Autor: {{ artigo.author.nome_completo or artigo.author.username }} |
          Criado em: {{ artigo.created_at.strftime('%d/%m/%Y %H:%M') }}
        </p>
        <hr>
        <div>{{ artigo.texto.replace('\n','<br>')|safe }}</div>

        {% if arquivos %}
        <hr><h5>Anexos</h5>
        <div class="row g-3">
          {% for fname in arquivos %}
            {% set ext = fname.split('.')[-1].lower() %}
            <div class="col-4 col-md-3">
              <a href="{{ url_for('uploaded_file', filename=fname) }}"
                 class="text-decoration-none" target="_blank">
                <div class="card h-100">
                  {# mesmas condições de ícones e preview do aprovacao_detail #}
                </div>
              </a>
            </div>
          {% endfor %}
        </div>
        {% else %}
          <p class="text-muted mt-3">Sem anexos.</p>
        {% endif %}

        {# Badge de status #}
        <p class="text-muted mt-3"><strong>Status:</strong> {{ artigo.status|replace('_',' ')|capitalize }}</p>

        {# Histórico de solicitações #}
        {% if artigo.revision_requests %}
        <hr><h5>Solicitações de Revisão</h5>
        <ul class="list-unstyled">
          {% for rr in artigo.revision_requests %}
          <li>
            <strong>{{ rr.user.username }}</strong>
            ({{ rr.created_at.strftime('%d/%m/%Y %H:%M') }}):
            {{ rr.comentario }}
          </li>
          {% endfor %}
        </ul>
        {% endif %}

        <div class="mt-4">
          {% if session.username and (artigo.author.username == session.username or session.role in ['editor','admin']) %}
            <a href="{{ url_for('artigo', artigo_id=artigo.id) }}" class="btn btn-primary">Editar</a>
          {% endif %}
          {% if session.username and artigo.status != 'in_review' %}
            <a href="{{ url_for('solicitar_revisao', artigo_id=artigo.id) }}" class="btn btn-warning">Solicitar revisão</a>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}