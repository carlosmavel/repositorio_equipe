{% extends "base.html" %}

{% block title %}{{ artigo.titulo }}{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3>{{ artigo.titulo }}</h3>
          <p class="text-muted">
            Autor: {{ artigo.author.nome_completo or artigo.author.username }} |
            Criado em: {{ artigo.created_at.strftime('%d/%m/%Y %H:%M') }}
          </p>
          <hr>
          <div>
            {{ artigo.texto.replace('\n','<br>')|safe }}
          </div>

          {% if arquivos %}
            <hr>
            <h5>Anexos</h5>
            <div class="row g-3">
              {% for fname in arquivos %}
                {% set ext = fname.split('.')[-1].lower() %}
                <div class="col-4 col-md-3">
                  <a href="{{ url_for('uploaded_file', filename=fname) }}" target="_blank" class="text-decoration-none">
                    <div class="card h-100">
                      {% if ext in ['jpg','jpeg','png','gif'] %}
                        <img src="{{ url_for('uploaded_file', filename=fname) }}"
                             class="card-img-top"
                             style="height:100px; object-fit:cover;"
                             alt="{{ fname }}">
                      {% elif ext == 'pdf' %}
                        <img src="{{ url_for('static', filename='icons/pdf-icon.png') }}"
                             class="card-img-top p-3"
                             style="height:100px; object-fit:contain;"
                             alt="PDF">
                      {% elif ext in ['xls','xlsx'] %}
                        <img src="{{ url_for('static', filename='icons/excel-icon.png') }}"
                             class="card-img-top p-3"
                             style="height:100px; object-fit:contain;"
                             alt="Excel">
                      {% else %}
                        <img src="{{ url_for('static', filename='icons/file-icon.png') }}"
                             class="card-img-top p-3"
                             style="height:100px; object-fit:contain;"
                             alt="Arquivo">
                      {% endif %}
                      <div class="card-body p-2">
                        <p class="card-text text-truncate" title="{{ fname }}" style="font-size:0.85em;">
                          {{ fname }}
                        </p>
                      </div>
                    </div>
                  </a>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted mt-3">Sem anexos.</p>
          {% endif %}

          <p class="text-muted mt-3"><strong>Status:</strong> {{ artigo.status|capitalize }}</p>

          {% if artigo.review_comment %}
            <hr>
            <h5>Comentário do Revisor</h5>
            <div class="card border-secondery mb-3">
              <div class="card-body">
                {{ artigo.review_comment.replace('\n','<br>')|safe }}
              </div>
            </div>
          {% endif %}

          {% if session.role in ['colaborador','editor','admin'] and artigo.status in ['pendente','em_ajuste','rejeitado'] %}
            <hr>
            <h5>Editar Artigo</h5>
            <form method="POST" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="titulo-edit" class="form-label">
                  <i class="bi bi-fonts" title="Título"></i> Título
                </label>
                <input type="text" id="titulo-edit" name="titulo" class="form-control" value="{{ artigo.titulo }}" required>
              </div>
              <div class="mb-3">
                <label for="texto-edit" class="form-label">
                  <i class="bi bi-text-paragraph" title="Texto"></i> Texto
                </label>
                <textarea id="texto-edit" name="texto" class="form-control" rows="5" required>{{ artigo.texto }}</textarea>
              </div>
              <div class="mb-3">
                <label for="files-edit" class="form-label">
                  <i class="bi bi-paperclip" title="Anexar Arquivos"></i> Anexos
                </label>
                <input type="file" id="files-edit" name="files" class="form-control" multiple>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-pencil-square"></i> Salvar
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}