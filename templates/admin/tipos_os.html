{% extends "base.html" %}
{% block title %}Tipos de OS{% endblock %}
{% block content %}
<div class="container mt-3">
  <h1>Tipos de OS</h1>
  <table class="table table-sm">
    <thead>
      <tr><th>Nome</th><th>Subprocesso</th><th>Equipe</th><th>Formulário</th><th>Obrigatório</th><th>Ações</th></tr>
    </thead>
    <tbody>
      {% for t in tipos %}
      <tr>
        <td>{{ t.nome }}</td>
        <td>{{ t.subprocesso.nome }}</td>
        <td>{{ t.equipe_responsavel.nome if t.equipe_responsavel else '-' }}</td>
        <td>{{ formularios_dict.get(t.formulario_vinculado_id).nome if t.formulario_vinculado_id else '-' }}</td>
        <td>{{ 'Sim' if t.obrigatorio_preenchimento else 'Não' }}</td>
        <td>
          <a href="{{ url_for('ordens_servico_bp.admin_tipos_os', edit_id=t.id) }}" class="btn btn-sm btn-outline-primary me-1">Editar</a>
          <form method="POST" action="{{ url_for('ordens_servico_bp.admin_tipos_os_delete', id=t.id) }}" class="d-inline" onsubmit="return confirm('Excluir tipo de OS?');">
            <button class="btn btn-sm btn-outline-danger">Excluir</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="text-center text-muted">Nenhum tipo de OS cadastrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <hr>
  <h2 class="h5">{{ 'Editar Tipo de OS' if tipo_editar else 'Novo Tipo de OS' }}</h2>
  <form method="POST" action="{{ url_for('ordens_servico_bp.admin_tipos_os') }}" class="compact-form">
    {% if tipo_editar %}
    <input type="hidden" name="id_para_atualizar" value="{{ tipo_editar.id }}">
    {% endif %}
    <div class="mb-3">
      <label for="nome" class="form-label">Nome <span class="text-danger">*</span></label>
      <input type="text" class="form-control form-control-sm" id="nome" name="nome" required value="{{ request.form.get('nome', tipo_editar.nome if tipo_editar else '') }}">
    </div>
    <div class="mb-3">
      <label for="descricao" class="form-label">Descrição</label>
      <textarea class="form-control form-control-sm" id="descricao" name="descricao" rows="2">{{ request.form.get('descricao', tipo_editar.descricao if tipo_editar else '') }}</textarea>
    </div>
    <div class="mb-3">
      <label for="subprocesso_id" class="form-label">Subprocesso <span class="text-danger">*</span></label>
      <select class="form-select form-select-sm" id="subprocesso_id" name="subprocesso_id" required>
        <option value="">--</option>
        {% for sp in subprocessos %}
        <option value="{{ sp.id }}" {% if (request.form.get('subprocesso_id', tipo_editar.subprocesso_id|string if tipo_editar else '') == sp.id|string) %}selected{% endif %}>{{ sp.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="equipe_responsavel_id" class="form-label">Equipe Responsável</label>
      <select class="form-select form-select-sm" id="equipe_responsavel_id" name="equipe_responsavel_id">
        <option value="">--</option>
        {% for cel in celulas %}
        <option value="{{ cel.id }}" {% if (request.form.get('equipe_responsavel_id', tipo_editar.equipe_responsavel_id|string if tipo_editar else '') == cel.id|string) %}selected{% endif %}>{{ cel.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="formulario_vinculado_id" class="form-label">Formulário Vinculado</label>
      <select class="form-select form-select-sm" id="formulario_vinculado_id" name="formulario_vinculado_id">
        <option value="">--</option>
        {% for f in formularios %}
        <option value="{{ f.id }}" {% if (request.form.get('formulario_vinculado_id', tipo_editar.formulario_vinculado_id|string if tipo_editar else '') == f.id|string) %}selected{% endif %}>{{ f.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3 form-check">
      <input class="form-check-input" type="checkbox" id="obrigatorio_preenchimento" name="obrigatorio_preenchimento" {% if request.form.get('obrigatorio_preenchimento', tipo_editar.obrigatorio_preenchimento if tipo_editar else False) %}checked{% endif %}>
      <label class="form-check-label" for="obrigatorio_preenchimento">Formulário obrigatório?</label>
    </div>
    <button type="submit" class="btn btn-sm btn-primary">Salvar</button>
  </form>
</div>
{% endblock %}
