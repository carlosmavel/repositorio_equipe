{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom">
    <h1 class="h2">Gerenciar Ordens de Serviço</h1>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3>Cadastro</h3>
      <form method="POST" action="{{ url_for('ordens_servico_bp.admin_ordens_servico') }}" novalidate>
        {% if ordem_editar %}
        <input type="hidden" name="id_para_atualizar" value="{{ ordem_editar.id }}">
        {% endif %}
        <div class="mb-3">
          <label for="titulo" class="form-label">Título <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="titulo" name="titulo" value="{{ request.form.get('titulo', ordem_editar.titulo if ordem_editar else '') }}" required>
        </div>
        <div class="mb-3">
          <label for="descricao" class="form-label">Descrição</label>
          <textarea class="form-control" id="descricao" name="descricao" rows="3">{{ request.form.get('descricao', ordem_editar.descricao if ordem_editar else '') }}</textarea>
        </div>
        <div class="mb-3">
          <label for="tipo_os_id" class="form-label">Tipo</label>
          <select class="form-select" id="tipo_os_id" name="tipo_os_id" required>
            <option value="">--</option>
            {% for t in tipos_os %}
            <option value="{{ t.id }}" {% if ordem_editar and ordem_editar.tipo_os_id==t.id %}selected{% endif %}>{{ t.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="atribuido_para_id" class="form-label">Atribuído para</label>
          <input type="text" class="form-control" id="atribuido_para_id" name="atribuido_para_id" value="{{ request.form.get('atribuido_para_id', ordem_editar.atribuido_para_id if ordem_editar else '') }}">
        </div>
        <div class="mb-3">
          <label for="prioridade" class="form-label">Prioridade</label>
          <select class="form-select" id="prioridade" name="prioridade">
            <option value="">--</option>
            {% for p in prioridades %}
            <option value="{{ p.value }}" {% if ordem_editar and ordem_editar.prioridade==p.value %}selected{% endif %}>{{ p.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3 d-none" id="equipamento_field">
          <label for="equipamento_id" class="form-label">Equipamento</label>
          <select class="form-select" id="equipamento_id" name="equipamento_id">
            <option value="">--</option>
            {% for e in equipamentos %}
            <option value="{{ e.id }}" {% if ordem_editar and ordem_editar.equipamento_id==e.id %}selected{% endif %}>{{ e.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3 d-none" id="sistema_field">
          <label for="sistema_id" class="form-label">Sistema</label>
          <select class="form-select" id="sistema_id" name="sistema_id">
            <option value="">--</option>
            {% for s in sistemas %}
            <option value="{{ s.id }}" {% if ordem_editar and ordem_editar.sistema_id==s.id %}selected{% endif %}>{{ s.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="observacoes" class="form-label">Observações</label>
          <textarea class="form-control" id="observacoes" name="observacoes" rows="3">{{ request.form.get('observacoes', ordem_editar.observacoes if ordem_editar else '') }}</textarea>
        </div>
        <div class="mb-3">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" name="status">
            {% for st in status_choices %}
            <option value="{{ st.value }}" {% if ordem_editar and ordem_editar.status==st.value %}selected{% elif not ordem_editar and st.value=='rascunho' %}selected{% endif %}>{{ st.label }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </form>
    </div>
    <div class="col-md-6">
      <h3>Ordens</h3>
      {% if ordens %}
      <table class="table table-sm">
        <thead><tr><th>Título</th><th>Status</th><th>Ações</th></tr></thead>
        <tbody>
        {% for os in ordens %}
        <tr>
          <td>{{ os.titulo }}</td>
          <td>{{ status_choices(os.status).label }}</td>
          <td>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('ordens_servico_bp.admin_ordens_servico', edit_id=os.id) }}">Editar</a>
            <form action="{{ url_for('ordens_servico_bp.admin_delete_ordem', ordem_id=os.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">Nenhuma ordem cadastrada.</p>
      {% endif %}
  </div>
</div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  let inputs = form.querySelectorAll('input, textarea, select');
  const idField = form.querySelector('input[name="id_para_atualizar"]');
  const STORAGE_KEY = 'draft_admin_os_' + (idField ? idField.value || 'novo' : 'novo');
  const tipoSelect = document.getElementById('tipo_os_id');
  const equipamento = document.getElementById('equipamento_id');
  const sistema = document.getElementById('sistema_id');
  const equipamentoField = document.getElementById('equipamento_field');
  const sistemaField = document.getElementById('sistema_field');
  function save() {
    const data = {};
    inputs.forEach(i => data[i.id] = i.value);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      inputs.forEach(i => { if (data[i.id]) i.value = data[i.id]; });
    } catch (e) {
      console.warn('Falha ao carregar rascunho da OS', e);
    }
  }
  function atualizarCampos() {
    const texto = tipoSelect.options[tipoSelect.selectedIndex]?.text || '';
    if (texto === 'Suporte ao Sistema') {
      sistemaField.classList.remove('d-none');
      equipamentoField.classList.add('d-none');
      sistema.setAttribute('required', 'required');
      equipamento.removeAttribute('required');
      sistemaField.querySelector('label').innerHTML = 'Sistema <span class="text-danger">*</span>';
      equipamentoField.querySelector('label').innerHTML = 'Equipamento';
    } else if (texto === 'Manutenção de Equipamento') {
      equipamentoField.classList.remove('d-none');
      sistemaField.classList.add('d-none');
      equipamento.setAttribute('required', 'required');
      sistema.removeAttribute('required');
      equipamentoField.querySelector('label').innerHTML = 'Equipamento <span class="text-danger">*</span>';
      sistemaField.querySelector('label').innerHTML = 'Sistema';
    } else {
      equipamentoField.classList.add('d-none');
      sistemaField.classList.add('d-none');
      equipamento.removeAttribute('required');
      sistema.removeAttribute('required');
      equipamentoField.querySelector('label').innerHTML = 'Equipamento';
      sistemaField.querySelector('label').innerHTML = 'Sistema';
    }
  }
  load();
  atualizarCampos();
  inputs.forEach(i => i.addEventListener('input', save));
  tipoSelect.addEventListener('change', () => {
    atualizarCampos();
  });
  form.addEventListener('submit', (e) => {
    const texto = tipoSelect.options[tipoSelect.selectedIndex]?.text || '';
    if (texto === 'Suporte ao Sistema' && !sistema.value) {
      e.preventDefault();
      alert("O campo Sistema é obrigatório para OS do tipo 'Suporte ao Sistema'.");
      return;
    }
    if (texto === 'Manutenção de Equipamento' && !equipamento.value) {
      e.preventDefault();
      alert("O campo Equipamento é obrigatório para OS do tipo 'Manutenção de Equipamento'.");
      return;
    }
    localStorage.removeItem(STORAGE_KEY);
  });
});
</script>
{% endblock %}
