{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom">
    <h1 class="h2">Gerenciar Ordens de Serviço</h1>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3>Cadastro</h3>
      <form method="POST" action="{{ url_for('ordens_servico_bp.admin_ordens_servico') }}" novalidate>
        {% if ordem_editar %}
        <input type="hidden" name="id_para_atualizar" value="{{ ordem_editar.id }}">
        {% endif %}
        <div class="mb-3">
          <label for="titulo" class="form-label">Título <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="titulo" name="titulo" value="{{ request.form.get('titulo', ordem_editar.titulo if ordem_editar else '') }}" required>
        </div>
        <div class="mb-3">
          <label for="descricao" class="form-label">Descrição</label>
          <textarea class="form-control" id="descricao" name="descricao" rows="3">{{ request.form.get('descricao', ordem_editar.descricao if ordem_editar else '') }}</textarea>
        </div>
        <div class="mb-3">
          <label for="tipo_os_id" class="form-label">Tipo</label>
          <select class="form-select" id="tipo_os_id" name="tipo_os_id" required>
            <option value="">--</option>
            {% for t in tipos_os %}
            <option value="{{ t.id }}" {% if ordem_editar and ordem_editar.tipo_os_id==t.id %}selected{% endif %}>{{ t.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="atribuido_para_id" class="form-label">Atribuído para</label>
          <input type="text" class="form-control" id="atribuido_para_id" name="atribuido_para_id" value="{{ request.form.get('atribuido_para_id', ordem_editar.atribuido_para_id if ordem_editar else '') }}">
        </div>
        <div class="mb-3">
          <label for="prioridade" class="form-label">Prioridade</label>
          <select class="form-select" id="prioridade" name="prioridade">
            <option value="">--</option>
            {% for p in prioridades %}
            <option value="{{ p.value }}" {% if ordem_editar and ordem_editar.prioridade==p.value %}selected{% endif %}>{{ p.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label for="origem" class="form-label">Origem</label>
          <input type="text" class="form-control" id="origem" name="origem" value="{{ request.form.get('origem', ordem_editar.origem if ordem_editar else '') }}">
        </div>
        <div class="mb-3">
          <label for="observacoes" class="form-label">Observações</label>
          <textarea class="form-control" id="observacoes" name="observacoes" rows="3">{{ request.form.get('observacoes', ordem_editar.observacoes if ordem_editar else '') }}</textarea>
        </div>
        <div class="mb-3">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" name="status">
            {% for st in status_choices %}
            <option value="{{ st.value }}" {% if ordem_editar and ordem_editar.status==st.value %}selected{% elif not ordem_editar and st.value=='rascunho' %}selected{% endif %}>{{ st.label }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </form>
    </div>
    <div class="col-md-6">
      <h3>Ordens</h3>
      {% if ordens %}
      <table class="table table-sm">
        <thead><tr><th>Título</th><th>Status</th><th>Ações</th></tr></thead>
        <tbody>
        {% for os in ordens %}
        <tr>
          <td>{{ os.titulo }}</td>
          <td>{{ os.status }}</td>
          <td>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('ordens_servico_bp.admin_ordens_servico', edit_id=os.id) }}">Editar</a>
            <form action="{{ url_for('ordens_servico_bp.admin_delete_ordem', ordem_id=os.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">Nenhuma ordem cadastrada.</p>
      {% endif %}
  </div>
</div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  const inputs = form.querySelectorAll('input, textarea, select');
  const idField = form.querySelector('input[name="id_para_atualizar"]');
  const STORAGE_KEY = 'draft_admin_os_' + (idField ? idField.value || 'novo' : 'novo');
  function save() {
    const data = {};
    inputs.forEach(i => data[i.id] = i.value);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      inputs.forEach(i => { if (data[i.id]) i.value = data[i.id]; });
    } catch (e) {
      console.warn('Falha ao carregar rascunho da OS', e);
    }
  }
  load();
  inputs.forEach(i => i.addEventListener('input', save));
  form.addEventListener('submit', () => localStorage.removeItem(STORAGE_KEY));
});
</script>
{% endblock %}
