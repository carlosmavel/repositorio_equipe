{% extends "base.html" %}
{% block title %}Admin - Subprocessos{% endblock %}
{% block content %}
<div class="container-fluid px-5 mt-3">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom">
    <h1 class="h2">Subprocessos</h1>
  </div>
  <ul class="nav nav-tabs" id="tabSubproc" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta" type="button" role="tab">Consulta</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button" role="tab">Cadastro</button>
    </li>
  </ul>
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="tab-content" id="tabSubprocContent">
        <div class="tab-pane fade show active p-3" id="consulta" role="tabpanel" aria-labelledby="consulta-tab">
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Subprocessos Cadastrados ({{ subprocessos|length }})</h5>
            </div>
            <div class="card-body">
              {% if subprocessos %}
                <div class="table-responsive">
                  <table class="table table-hover table-sm align-middle">
                    <thead>
                      <tr>
                        <th>Nome</th>
                        <th>Processo</th>
                        <th style="width: 120px;" class="text-end">Ações</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for sp in subprocessos %}
                      <tr class="clickable-row" data-href="{{ url_for('processos_bp.admin_subprocessos', edit_id=sp.id) }}">
                        <td>{{ sp.nome }}</td>
                        <td>{{ sp.processo.nome }}</td>
                        <td class="text-end">
                          <a href="{{ url_for('processos_bp.admin_subprocessos', edit_id=sp.id) }}" class="btn btn-sm btn-outline-primary" title="Editar"><i class="bi bi-pencil-fill"></i></a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-muted">Nenhum subprocesso cadastrado.</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="tab-pane fade p-3" id="cadastro" role="tabpanel" aria-labelledby="cadastro-tab">
          <h5 class="mb-3"><i class="bi bi-plus-circle-fill me-2"></i>{{ 'Editar Subprocesso' if subprocesso_editar else 'Adicionar Subprocesso' }}</h5>
          <form method="POST" action="{{ url_for('processos_bp.admin_subprocessos') }}" class="compact-form" novalidate>
            {% if subprocesso_editar %}
            <input type="hidden" name="id_para_atualizar" value="{{ subprocesso_editar.id }}">
            {% endif %}
            <div class="mb-1">
              <label for="nome" class="form-label">Nome <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" id="nome" name="nome" required value="{{ request.form.get('nome', subprocesso_editar.nome if subprocesso_editar else '') }}">
            </div>
            <div class="mb-1">
              <label for="processo_id" class="form-label">Processo <span class="text-danger">*</span></label>
              <select class="form-select form-select-sm" id="processo_id" name="processo_id" required>
                <option value="">--</option>
                {% for proc in processos %}
                <option value="{{ proc.id }}" {% if (request.form.get('processo_id', subprocesso_editar.processo_id|string if subprocesso_editar else '') == proc.id|string) %}selected{% endif %}>{{ proc.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="d-flex pt-2 border-top">
              <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% if subprocesso_editar %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    var tab = new bootstrap.Tab(document.getElementById('cadastro-tab'));
    tab.show();
  });
</script>
{% endif %}
{% endblock %}
