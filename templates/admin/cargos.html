{% extends "base.html" %}

{% block title %}Admin - Gerenciar Cargos{% endblock %}

{% block content %}
<div class="container-fluid px-5 mt-3">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom">
        <h1 class="h2">Gerenciar Cargos</h1>
    </div>

    <ul class="nav nav-tabs" id="tabCargo" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta" type="button" role="tab">Consulta</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button" role="tab">Cadastro</button>
        </li>
    </ul>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="tab-content" id="tabCargoContent">
                <div class="tab-pane fade show active p-3" id="consulta" role="tabpanel" aria-labelledby="consulta-tab">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Cargos Cadastrados</h5>
                        </div>
                        <div class="card-body">
                            {% if estrutura %}
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" id="cargoSearch" class="form-control" placeholder="Buscar por cargo, setor, célula ou instituição">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleGraph">Visualização em grafo</button>
                                        <button class="btn btn-outline-secondary d-none" type="button" id="toggleTree">Voltar à visualização em árvore</button>
                                    </div>
                                </div>
                                <div class="ms-2" id="cargoContainer">
                                    {% for inst in estrutura %}
                                        <div class="card mb-2 instituicao-container">
                                            <div class="card-header d-flex align-items-center">
                                                <button class="btn btn-sm btn-link p-0 me-2 toggle-section caret-toggle expanded" data-level="setores" data-bs-toggle="collapse" data-bs-target="#inst-{{ inst.obj.id }}" aria-expanded="true"><i class="bi bi-caret-right-fill"></i></button>
                                                <h5 class="mb-0">Instituição: <span class="inst-name" data-name="{{ inst.obj.nome }}">{{ inst.obj.nome }}</span></h5>
                                            </div>
                                            <div id="inst-{{ inst.obj.id }}" class="collapse show">
                                                {% for est in inst.estabelecimentos %}
                                                    <div class="ms-4 mb-3 p-2 border rounded estabelecimento-wrapper">
                                                        <h6 class="fw-bold">Estabelecimento: <span class="est-name" data-name="{{ est.obj.nome_fantasia }}">{{ est.obj.nome_fantasia }}</span></h6>
                                                        <div class="estabelecimento-conteudo mt-2">
                                                            {% for setor in est.setores %}
                                                            <div class="setor-container p-2 mb-2 rounded">
                                                                <div class="d-flex align-items-center">
                                                                    <button class="btn btn-sm btn-link p-0 me-2 toggle-section caret-toggle expanded" data-level="celulas" data-bs-toggle="collapse" data-bs-target="#setor-{{ setor.obj.id }}" aria-expanded="true"><i class="bi bi-caret-right-fill"></i></button>
                                                                    <strong class="mb-0">Setor: <span class="setor-name" data-name="{{ setor.obj.nome }}">{{ setor.obj.nome }}</span></strong>
                                                                </div>
                                                                <div id="setor-{{ setor.obj.id }}" class="ms-3 collapse show">
                                                                    {% if setor.cargos %}
                                                                        <ul class="list-group list-group-flush mb-2">
                                                                            {% for cargo in setor.cargos %}
                                                                                <li class="list-group-item cargo-item {{ 'text-muted' if not cargo.ativo else '' }}" data-cargo="{{ cargo.nome }}" data-setor="{{ setor.obj.nome }}" data-celula="" data-instituicao="{{ inst.obj.nome }}">
                                                                                    <div class="linha-cargo">
                                                                                        <div class="nome-cargo cargo-name" data-name="{{ cargo.nome }}" data-url="{{ url_for('admin_cargos', edit_id=cargo.id) }}#cadastro">{{ cargo.nome }}</div>
                                                                                        <div class="acoes-cargo">
                                                                                        {% set confirm_message_text = 'DESATIVAR' if cargo.ativo else 'ATIVAR' %}
                                                                                        {% set cargo_nome_js = cargo.nome | tojson %}
                                                                                        <form action="{{ url_for('admin_toggle_ativo_cargo', id=cargo.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja {{ confirm_message_text }} o cargo ' + {{ cargo_nome_js }} + '?');">
                                                                                            {% if cargo.ativo %}
                                                                                                <button type="submit" class="btn btn-sm btn-outline-warning" title="Desativar Cargo">
                                                                                                    <i class="bi bi-toggle-on"></i>
                                                                                                </button>
                                                                                            {% else %}
                                                                                                <button type="submit" class="btn btn-sm btn-outline-success" title="Ativar Cargo">
                                                                                                    <i class="bi bi-toggle-off"></i>
                                                                                                </button>
                                                                                            {% endif %}
                                                                                        </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>
                                                                            {% endfor %}
                                                                        </ul>
                                                                    {% endif %}
                                                                    {% for cel in setor.celulas %}
                                                                        <div class="celula-container ps-3 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <button class="btn btn-sm btn-link p-0 me-2 toggle-section caret-toggle expanded" data-level="cargos" data-bs-toggle="collapse" data-bs-target="#cel-{{ cel.obj.id }}" aria-expanded="true"><i class="bi bi-caret-right-fill"></i></button>
                                                                                <span class="fw-bold">Célula: <span class="celula-name" data-name="{{ cel.obj.nome }}">{{ cel.obj.nome }}</span></span>
                                                                            </div>
                                                                            <div id="cel-{{ cel.obj.id }}" class="ms-3 collapse show">
                                                                                {% if cel.cargos %}
                                                                                    <ul class="list-group list-group-flush">
                                                                                        {% for cargo in cel.cargos %}
                                                                                            <li class="list-group-item cargo-item {{ 'text-muted' if not cargo.ativo else '' }}" data-cargo="{{ cargo.nome }}" data-setor="{{ setor.obj.nome }}" data-celula="{{ cel.obj.nome }}" data-instituicao="{{ inst.obj.nome }}">
                                                                                                <div class="linha-cargo">
                                                                                                    <div class="nome-cargo cargo-name" data-name="{{ cargo.nome }}" data-url="{{ url_for('admin_cargos', edit_id=cargo.id) }}#cadastro">{{ cargo.nome }}</div>
                                                                                                    <div class="acoes-cargo">
                                                                                                        {% set confirm_message_text = 'DESATIVAR' if cargo.ativo else 'ATIVAR' %}
                                                                                                        {% set cargo_nome_js = cargo.nome | tojson %}
                                                                                                        <form action="{{ url_for('admin_toggle_ativo_cargo', id=cargo.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja {{ confirm_message_text }} o cargo ' + {{ cargo_nome_js }} + '?');">
                                                                                                            {% if cargo.ativo %}
                                                                                                                <button type="submit" class="btn btn-sm btn-outline-warning" title="Desativar Cargo">
                                                                                                                    <i class="bi bi-toggle-on"></i>
                                                                                                                </button>
                                                                                                            {% else %}
                                                                                                                <button type="submit" class="btn btn-sm btn-outline-success" title="Ativar Cargo">
                                                                                                                    <i class="bi bi-toggle-off"></i>
                                                                                                                </button>
                                                                                                            {% endif %}
                                                                                                        </form>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </li>
                                                                                        {% endfor %}
                                                                                    </ul>
                                                                                {% else %}
                                                                                    <p class="text-muted ms-3">Nenhum cargo nesta célula.</p>
                                                                                {% endif %}
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="d-none" id="graphContainer">
                                    <div id="cargoGraph" style="width: 100%; height: 600px;"></div>
                                </div>
                            {% else %}
                                <p class="text-muted">Nenhum cargo cadastrado ainda. Adicione um acima!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="cargoModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="cargoModalLabel"></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <iframe id="cargoModalFrame" style="width:100%;height:500px;border:none;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade p-3" id="cadastro" role="tabpanel" aria-labelledby="cadastro-tab">
                    <h5 class="mb-3">
                        <i class="bi bi-plus-circle-fill me-2"></i>Adicionar Novo Cargo
                    </h5>

                    <form method="POST" action="{{ url_for('admin_cargos') }}" novalidate class="compact-form">
                        <div class="row">
                            <div class="col-md-8 mb-1">
                                <label for="nome" class="form-label">Nome <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="nome" name="nome" value="{{ request.form.get('nome', '') }}" required maxlength="200" placeholder="Nome do cargo">
                            </div>
                            <div class="col-md-4 mb-1">
                                <label for="nivel_hierarquico" class="form-label">Nível Hierárquico</label>
                                <select class="form-select form-select-sm" id="nivel_hierarquico" name="nivel_hierarquico">
                                    <option value="">Selecione</option>
                                    {% for val, nome in NIVEIS_HIERARQUICOS %}
                                        <option value="{{ val }}" {% if request.form.get('nivel_hierarquico') == val|string %}selected{% endif %}>{{ nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mb-1">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control form-control-sm" id="descricao" name="descricao" rows="3">{{ request.form.get('descricao', '') }}</textarea>
                        </div>
                        <div class="card mb-3">
                            <div class="card-header"><h6 class="mb-0">Hierarquia Padrão</h6></div>
                            <div class="card-body">
                                {% for inst in estrutura %}
                                    <div class="fw-bold mb-1">Instituição: {{ inst.obj.nome }}</div>
                                    {% for est in inst.estabelecimentos %}
                                        <div class="ms-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="c_est{{ est.obj.id }}" value="{{ est.obj.id }}" disabled>
                                                <label class="form-check-label fw-bold" for="c_est{{ est.obj.id }}">Estabelecimento: {{ est.obj.nome_fantasia }}</label>
                                            </div>
                                            {% if est.setores %}
                                                <div class="ms-4">
                                                    {% for st in est.setores %}
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="c_setor{{ st.obj.id }}" name="setor_ids" value="{{ st.obj.id }}" {% if st.obj.id|string in request.form.getlist('setor_ids') %}checked{% endif %}>
                                                            <label class="form-check-label" for="c_setor{{ st.obj.id }}">Setor: {{ st.obj.nome }}</label>
                                                        </div>
                                                        {% if st.celulas %}
                                                            <div class="ms-4 mb-2">
                                                                {% for cel in st.celulas %}
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox" id="c_celula{{ cel.obj.id }}" name="celula_ids" value="{{ cel.obj.id }}" {% if cel.obj.id|string in request.form.getlist('celula_ids') %}checked{% endif %}>
                                                                        <label class="form-check-label" for="c_celula{{ cel.obj.id }}">Célula: {{ cel.obj.nome }}</label>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endfor %}
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Permissões Ordem de Serviço</h6></div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="pode_atender_os" name="pode_atender_os" {% if request.form.get('pode_atender_os') == 'on' %}checked{% endif %}>
                                <label class="form-check-label" for="pode_atender_os">Pode atender OS?</label>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Permissões de Artigos</h6></div>
                        <div class="card-body">
                            {% set grupos = [
                                ('Célula', [
                                    Permissao.ARTIGO_EDITAR_CELULA.value,
                                    Permissao.ARTIGO_APROVAR_CELULA.value,
                                    Permissao.ARTIGO_REVISAR_CELULA.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_CELULA.value
                                ]),
                                ('Setor', [
                                    Permissao.ARTIGO_EDITAR_SETOR.value,
                                    Permissao.ARTIGO_APROVAR_SETOR.value,
                                    Permissao.ARTIGO_REVISAR_SETOR.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_SETOR.value
                                ]),
                                ('Estabelecimento', [
                                    Permissao.ARTIGO_EDITAR_ESTABELECIMENTO.value,
                                    Permissao.ARTIGO_APROVAR_ESTABELECIMENTO.value,
                                    Permissao.ARTIGO_REVISAR_ESTABELECIMENTO.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_ESTABELECIMENTO.value
                                ]),
                                ('Instituição', [
                                    Permissao.ARTIGO_EDITAR_INSTITUICAO.value,
                                    Permissao.ARTIGO_APROVAR_INSTITUICAO.value,
                                    Permissao.ARTIGO_REVISAR_INSTITUICAO.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_INSTITUICAO.value
                                ]),
                                ('Todas as Unidades', [
                                    Permissao.ARTIGO_EDITAR_TODAS.value,
                                    Permissao.ARTIGO_APROVAR_TODAS.value,
                                    Permissao.ARTIGO_REVISAR_TODAS.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_TODAS.value
                                ])
                            ] %}

                            {# Permissão para criar artigos - não faz parte de um grupo #}
                            {% for f in funcoes if f.codigo == 'artigo_criar' %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="c_funcao{{ f.id }}" name="funcao_ids" value="{{ f.id }}" {% if f.id|string in request.form.getlist('funcao_ids') %}checked{% endif %}>
                                    <label class="form-check-label" for="c_funcao{{ f.id }}">{{ f.nome }}</label>
                                </div>
                            {% endfor %}

                            {% for label, codes in grupos %}
                                <div class="mt-2"><strong>{{ label }}</strong></div>
                                {% for f in funcoes if f.codigo in codes %}
                                    <div class="form-check ms-3">
                                        <input class="form-check-input" type="checkbox" id="c_funcao{{ f.id }}" name="funcao_ids" value="{{ f.id }}" {% if f.id|string in request.form.getlist('funcao_ids') %}checked{% endif %}>
                                        <label class="form-check-label" for="c_funcao{{ f.id }}">{{ f.nome }}</label>
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Permissões Globais</h6></div>
                        <div class="card-body">
                            {% for f in funcoes if f.codigo == 'admin' %}
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="c_admin{{ f.id }}" name="funcao_ids" value="{{ f.id }}" {% if f.id|string in request.form.getlist('funcao_ids') %}checked{% endif %}>
                                    <label class="form-check-label" for="c_admin{{ f.id }}">Administrador Global</label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-12 mb-1">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="ativo_check" name="ativo_check" checked>
                                <label class="form-check-label" for="ativo_check">
                                    Ativo
                                </label>
                            </div>
                        </div>
                        <div class="d-flex pt-2 border-top">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>
                                Adicionar Cargo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% if cargo_editar %}
<div class="modal fade" id="modalEditarCargo" tabindex="-1" aria-labelledby="modalEditarCargoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarCargoLabel">Editar Cargo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('admin_cargos') }}" novalidate class="compact-form">
                    <input type="hidden" name="id_para_atualizar" value="{{ cargo_editar.id }}">
                    <div class="row">
                        <div class="col-md-8 mb-1">
                            <label for="edit_nome" class="form-label">Nome <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="edit_nome" name="nome" value="{{ request.form.get('nome', cargo_editar.nome) }}" required maxlength="200">
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="edit_nivel_hierarquico" class="form-label">Nível Hierárquico</label>
                            <select class="form-select form-select-sm" id="edit_nivel_hierarquico" name="nivel_hierarquico">
                                <option value="">Selecione</option>
                                {% for val, nome in NIVEIS_HIERARQUICOS %}
                                    <option value="{{ val }}" {% if (request.form.get('nivel_hierarquico', cargo_editar.nivel_hierarquico|string) == val|string) %}selected{% endif %}>{{ nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-1">
                        <label for="edit_descricao" class="form-label">Descrição</label>
                        <textarea class="form-control form-control-sm" id="edit_descricao" name="descricao" rows="3">{{ request.form.get('descricao', cargo_editar.descricao or '') }}</textarea>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Hierarquia Padrão</h6></div>
                        <div class="card-body">
                            {% for est in estabelecimentos %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="e_est{{ est.id }}" value="{{ est.id }}" disabled>
                                    <label class="form-check-label fw-bold" for="e_est{{ est.id }}">{{ est.nome_fantasia }}</label>
                                </div>
                                {% set setores_est = est.setores.all() %}
                                {% if setores_est %}
                                    <div class="ms-4">
                                        {% for st in setores_est %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="e_setor{{ st.id }}" name="setor_ids" value="{{ st.id }}" {% if (request.form.getlist('setor_ids') and st.id|string in request.form.getlist('setor_ids')) or (not request.form.getlist('setor_ids') and (st in cargo_editar.default_setores.all())) %}checked{% endif %}>
                                                <label class="form-check-label" for="e_setor{{ st.id }}">{{ st.nome }}</label>
                                            </div>
                                            {% set celulas_set = st.celulas.all() %}
                                            {% if celulas_set %}
                                                <div class="ms-4 mb-2">
                                                    {% for cel in celulas_set %}
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="e_celula{{ cel.id }}" name="celula_ids" value="{{ cel.id }}" {% if (request.form.getlist('celula_ids') and cel.id|string in request.form.getlist('celula_ids')) or (not request.form.getlist('celula_ids') and (cel in cargo_editar.default_celulas.all())) %}checked{% endif %}>
                                                            <label class="form-check-label" for="e_celula{{ cel.id }}">{{ cel.nome }}</label>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Permissões Ordem de Serviço</h6></div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="edit_pode_atender_os" name="pode_atender_os" {% if (request.form.get('pode_atender_os') == 'on') or (not request.form.get('pode_atender_os') and cargo_editar.pode_atender_os) %}checked{% endif %}>
                                <label class="form-check-label" for="edit_pode_atender_os">Pode atender OS?</label>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Permissões de Artigos</h6></div>
                    <div class="card-body">
                            {% set grupos = [
                                ('Célula', [
                                    Permissao.ARTIGO_EDITAR_CELULA.value,
                                    Permissao.ARTIGO_APROVAR_CELULA.value,
                                    Permissao.ARTIGO_REVISAR_CELULA.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_CELULA.value
                                ]),
                                ('Setor', [
                                    Permissao.ARTIGO_EDITAR_SETOR.value,
                                    Permissao.ARTIGO_APROVAR_SETOR.value,
                                    Permissao.ARTIGO_REVISAR_SETOR.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_SETOR.value
                                ]),
                                ('Estabelecimento', [
                                    Permissao.ARTIGO_EDITAR_ESTABELECIMENTO.value,
                                    Permissao.ARTIGO_APROVAR_ESTABELECIMENTO.value,
                                    Permissao.ARTIGO_REVISAR_ESTABELECIMENTO.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_ESTABELECIMENTO.value
                                ]),
                                ('Instituição', [
                                    Permissao.ARTIGO_EDITAR_INSTITUICAO.value,
                                    Permissao.ARTIGO_APROVAR_INSTITUICAO.value,
                                    Permissao.ARTIGO_REVISAR_INSTITUICAO.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_INSTITUICAO.value
                                ]),
                                ('Todas as Unidades', [
                                    Permissao.ARTIGO_EDITAR_TODAS.value,
                                    Permissao.ARTIGO_APROVAR_TODAS.value,
                                    Permissao.ARTIGO_REVISAR_TODAS.value,
                                    Permissao.ARTIGO_ASSUMIR_REVISAO_TODAS.value
                                ])
                            ] %}

                            {% for f in funcoes if f.codigo == 'artigo_criar' %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="e_funcao{{ f.id }}" name="funcao_ids" value="{{ f.id }}" {% if (request.form.getlist('funcao_ids') and f.id|string in request.form.getlist('funcao_ids')) or (not request.form.getlist('funcao_ids') and (f in cargo_editar.permissoes.all())) %}checked{% endif %}>
                                    <label class="form-check-label" for="e_funcao{{ f.id }}">{{ f.nome }}</label>
                                </div>
                            {% endfor %}

                            {% for label, codes in grupos %}
                                <div class="mt-2"><strong>{{ label }}</strong></div>
                                {% for f in funcoes if f.codigo in codes %}
                                    <div class="form-check ms-3">
                                        <input class="form-check-input" type="checkbox" id="e_funcao{{ f.id }}" name="funcao_ids" value="{{ f.id }}" {% if (request.form.getlist('funcao_ids') and f.id|string in request.form.getlist('funcao_ids')) or (not request.form.getlist('funcao_ids') and (f in cargo_editar.permissoes.all())) %}checked{% endif %}>
                                        <label class="form-check-label" for="e_funcao{{ f.id }}">{{ f.nome }}</label>
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Permissões Globais</h6></div>
                        <div class="card-body">
                            {% for f in funcoes if f.codigo == 'admin' %}
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="e_admin{{ f.id }}" name="funcao_ids" value="{{ f.id }}" {% if (request.form.getlist('funcao_ids') and f.id|string in request.form.getlist('funcao_ids')) or (not request.form.getlist('funcao_ids') and (f in cargo_editar.permissoes.all())) %}checked{% endif %}>
                                    <label class="form-check-label" for="e_admin{{ f.id }}">Administrador Global</label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-12 mb-1">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="edit_ativo_check" name="ativo_check" {% if cargo_editar.ativo %}checked{% endif %}>
                            <label class="form-check-label" for="edit_ativo_check">Ativo</label>
                        </div>
                    </div>
                    <div class="d-flex pt-2 border-top">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i> Salvar Alterações
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock content %}

{% block extra_js %}
<script>
window.cargoGraphElements = [
    {% for inst in estrutura %}
        { data: { id: 'inst{{ inst.obj.id }}', label: {{ inst.obj.nome|tojson }}, type: 'instituicao' } },
        {% for est in inst.estabelecimentos %}
            { data: { id: 'est{{ est.obj.id }}', label: {{ est.obj.nome_fantasia|tojson }}, type: 'estabelecimento' } },
            { data: { id: 'edge_inst{{ inst.obj.id }}_est{{ est.obj.id }}', source: 'inst{{ inst.obj.id }}', target: 'est{{ est.obj.id }}', rel: 'hierarquia' } },
            {% for setor in est.setores %}
                { data: { id: 'set{{ setor.obj.id }}', label: {{ setor.obj.nome|tojson }}, type: 'setor' } },
                { data: { id: 'edge_est{{ est.obj.id }}_set{{ setor.obj.id }}', source: 'est{{ est.obj.id }}', target: 'set{{ setor.obj.id }}', rel: 'hierarquia' } },
                {% for cargo in setor.cargos %}
                    { data: { id: 'cargo{{ cargo.id }}', label: {{ cargo.nome|tojson }}, type: 'cargo', color: '{{ '#1E90FF' if cargo.nivel_hierarquico == 8 else '#2E8B57' if cargo.nivel_hierarquico == 6 else '#800080' if cargo.nivel_hierarquico is not none and cargo.nivel_hierarquico <= 5 else '#999999' }}', shape: '{{ 'hexagon' if cargo.nivel_hierarquico is not none and cargo.nivel_hierarquico <= 5 else 'ellipse' }}', url: {{ url_for('admin_bp.admin_cargos', edit_id=cargo.id)|tojson }}, nivel: {{ cargo.nivel_hierarquico }} } },
                    { data: { id: 'edge_set{{ setor.obj.id }}_cargo{{ cargo.id }}', source: 'set{{ setor.obj.id }}', target: 'cargo{{ cargo.id }}', rel: 'hierarquia' } },
                    {% if cargo.nivel_hierarquico is not none and cargo.nivel_hierarquico <= 5 %}
                    { data: { id: 'edge_cargo{{ cargo.id }}_set{{ setor.obj.id }}', source: 'cargo{{ cargo.id }}', target: 'set{{ setor.obj.id }}', rel: 'gestao', label: '{{ 'Gerencia' if cargo.nivel_hierarquico in [1,2] else 'Supervisiona' if cargo.nivel_hierarquico in [3,4] else 'Lidera' }}' } },
                    {% endif %}
                {% endfor %}
                {% for cel in setor.celulas %}
                    { data: { id: 'cel{{ cel.obj.id }}', label: {{ cel.obj.nome|tojson }}, type: 'celula' } },
                    { data: { id: 'edge_set{{ setor.obj.id }}_cel{{ cel.obj.id }}', source: 'set{{ setor.obj.id }}', target: 'cel{{ cel.obj.id }}', rel: 'hierarquia' } },
                    {% for cargo in cel.cargos %}
                        { data: { id: 'cargo{{ cargo.id }}', label: {{ cargo.nome|tojson }}, type: 'cargo', color: '{{ '#1E90FF' if cargo.nivel_hierarquico == 8 else '#2E8B57' if cargo.nivel_hierarquico == 6 else '#800080' if cargo.nivel_hierarquico is not none and cargo.nivel_hierarquico <= 5 else '#999999' }}', shape: '{{ 'hexagon' if cargo.nivel_hierarquico is not none and cargo.nivel_hierarquico <= 5 else 'ellipse' }}', url: {{ url_for('admin_bp.admin_cargos', edit_id=cargo.id)|tojson }}, nivel: {{ cargo.nivel_hierarquico }} } },
                        { data: { id: 'edge_cel{{ cel.obj.id }}_cargo{{ cargo.id }}', source: 'cel{{ cel.obj.id }}', target: 'cargo{{ cargo.id }}', rel: 'hierarquia' } },
                        {% if cargo.nivel_hierarquico is not none and cargo.nivel_hierarquico <= 5 %}
                        { data: { id: 'edge_cargo{{ cargo.id }}_cel{{ cel.obj.id }}', source: 'cargo{{ cargo.id }}', target: 'cel{{ cel.obj.id }}', rel: 'gestao', label: '{{ 'Gerencia' if cargo.nivel_hierarquico in [1,2] else 'Supervisiona' if cargo.nivel_hierarquico in [3,4] else 'Lidera' }}' } },
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
];
</script>
<script src="{{ url_for('static', filename='js/cytoscape.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/cargo_graph.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.toggle-section').forEach(function(btn) {
        const icon = btn.querySelector('i');
        if (btn.getAttribute('aria-expanded') === 'true') {
            icon.classList.replace('bi-caret-right-fill', 'bi-caret-down-fill');
        }

        btn.addEventListener('click', function() {
            setTimeout(function() {
                if (btn.getAttribute('aria-expanded') === 'true') {
                    icon.classList.replace('bi-caret-right-fill', 'bi-caret-down-fill');
                } else {
                    icon.classList.replace('bi-caret-down-fill', 'bi-caret-right-fill');
                }
            }, 150);
        });
    });

    document.querySelectorAll('.cargo-name').forEach(function(el) {
        el.addEventListener('click', function() {
            const url = el.dataset.url;
            if (url) window.location.href = url;
        });
    });

    const searchInput = document.getElementById('cargoSearch');
    if (searchInput) {
        const highlightText = (term) => {
            document.querySelectorAll('.inst-name, .setor-name, .celula-name, .cargo-name').forEach(function(el) {
                const text = el.dataset.name;
                if (term && text.toLowerCase().includes(term)) {
                    const regex = new RegExp('(' + term.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&') + ')', 'gi');
                    el.innerHTML = text.replace(regex, '<span class="search-highlight">$1</span>');
                } else {
                    el.textContent = text;
                }
            });
        };

        searchInput.addEventListener('input', function() {
            const term = searchInput.value.toLowerCase();

            document.querySelectorAll('.cargo-item').forEach(function(item) {
                const cargo = item.dataset.cargo.toLowerCase();
                const setor = item.dataset.setor.toLowerCase();
                const celula = item.dataset.celula.toLowerCase();
                const inst = item.dataset.instituicao.toLowerCase();
                const match = cargo.includes(term) || setor.includes(term) || celula.includes(term) || inst.includes(term);
                item.style.display = match ? '' : 'none';
            });

            document.querySelectorAll('.celula-container').forEach(function(cel) {
                const hasVisible = Array.from(cel.querySelectorAll('.cargo-item')).some(li => li.style.display !== 'none');
                cel.style.display = hasVisible ? '' : 'none';
            });

            document.querySelectorAll('.setor-container').forEach(function(setor) {
                const hasVisible = Array.from(setor.querySelectorAll('.cargo-item, .celula-container')).some(el => el.style.display !== 'none');
                setor.style.display = hasVisible ? '' : 'none';
            });

            document.querySelectorAll('.instituicao-container').forEach(function(inst) {
                const hasVisible = Array.from(inst.querySelectorAll('.cargo-item')).some(el => el.style.display !== 'none');
                inst.style.display = hasVisible ? '' : 'none';
            });

            highlightText(term);
        });
    }
});
</script>
{% if cargo_editar %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var modal = new bootstrap.Modal(document.getElementById('modalEditarCargo'));
    modal.show();
});
</script>
{% endif %}
{% endblock %}
